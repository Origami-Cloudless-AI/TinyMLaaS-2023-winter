<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>tflm_hello_world - Adding support for new devices</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="tflm_hello_world - Adding support for new devices">
<meta property="og:description" content="">
<meta property="og:site-name" content="tflm_hello_world">
<meta name="twitter:title" content="tflm_hello_world - Adding support for new devices">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">tflm_hello_world</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../docs/architecture.html">docs</a></li><li class="breadcrumb-item"><a href="../docs/supporting_new_devices.html">Adding support for new devices</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">tflm_hello_world</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../00_core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">00_core.html</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../export.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">core</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../aws_s3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">aws_s3.html</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../compiling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">compiling.html</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../installing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">installing.html</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../observing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">observing.html</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../training.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">training.html</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">docs</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/architecture.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Architecture Guide</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/how to demonstrate tinymlaas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Demonstratation of TinyMLaaS WebApp</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/how to install tinymlaas on the cloud.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How to install TinyMLaaS on Cloud</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/known issues.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Known Issues</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/software-project-summer-kick-off.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction of this project</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/ui-guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">UI design guide</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/what to implement in the future.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">What to implement in the future</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/adding_datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Datasets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/huggingface_deployment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Deployment to Huggingface</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/installation_tinymlaas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TinyMLaaS installation guide (Linux)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/repository_structure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Repository structure description</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/supporting_new_devices.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Adding support for new devices</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#steps-to-adding-support-for-a-new-device" id="toc-steps-to-adding-support-for-a-new-device" class="nav-link active" data-scroll-target="#steps-to-adding-support-for-a-new-device">Steps to adding support for a new device</a>
  <ul class="collapse">
  <li><a href="#find-example-code-and-tutorials-for-the-device" id="toc-find-example-code-and-tutorials-for-the-device" class="nav-link" data-scroll-target="#find-example-code-and-tutorials-for-the-device">1. Find example code and tutorials for the device</a></li>
  <li><a href="#compile-the-tflite-micro-person_detection-example-for-the-device" id="toc-compile-the-tflite-micro-person_detection-example-for-the-device" class="nav-link" data-scroll-target="#compile-the-tflite-micro-person_detection-example-for-the-device">2. Compile the tflite-micro person_detection example for the device</a></li>
  <li><a href="#modify-the-example-to-work-with-models-created-by-tinymlaas" id="toc-modify-the-example-to-work-with-models-created-by-tinymlaas" class="nav-link" data-scroll-target="#modify-the-example-to-work-with-models-created-by-tinymlaas">3. Modify the example to work with models created by TinyMLaaS</a></li>
  <li><a href="#create-a-dockerfile-for-building-the-code" id="toc-create-a-dockerfile-for-building-the-code" class="nav-link" data-scroll-target="#create-a-dockerfile-for-building-the-code">4. Create a dockerfile for building the code</a></li>
  <li><a href="#modify-the-webapp-to-build-the-code" id="toc-modify-the-webapp-to-build-the-code" class="nav-link" data-scroll-target="#modify-the-webapp-to-build-the-code">5. Modify the Webapp to build the code</a></li>
  </ul></li>
  <li><a href="#debugging-tip" id="toc-debugging-tip" class="nav-link" data-scroll-target="#debugging-tip">Debugging Tip</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/lifeofborna/tflm_hello_world/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Adding support for new devices</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>Currently there are two supported devices: <strong>Arduino Nano 33 BLE Sense Lite</strong> and <strong>Arducam Pico4ML</strong>.</p>
<p>Supported means that the webapp is capable of building and uploading a person detection application on to the device, and predictions can be read from the device. Obviously the process will change as new features are added and more is required for adding support.</p>
<section id="steps-to-adding-support-for-a-new-device" class="level2">
<h2 class="anchored" data-anchor-id="steps-to-adding-support-for-a-new-device">Steps to adding support for a new device</h2>
<section id="find-example-code-and-tutorials-for-the-device" class="level3">
<h3 class="anchored" data-anchor-id="find-example-code-and-tutorials-for-the-device">1. Find example code and tutorials for the device</h3>
<p>Figure out how to compile and upload code to the device. Get some basic hello world or LED blink example to run on the device. Ideally you should be able to do this from the command line, since that is eventually required for the Dockerfile.</p>
</section>
<section id="compile-the-tflite-micro-person_detection-example-for-the-device" class="level3">
<h3 class="anchored" data-anchor-id="compile-the-tflite-micro-person_detection-example-for-the-device">2. Compile the <a href="https://github.com/tensorflow/tflite-micro/tree/main/tensorflow/lite/micro/examples/person_detection">tflite-micro person_detection example</a> for the device</h3>
<p>Generally it seems to be easier to use a device-specific tflite-micro repository instead of the main repository. We used <a href="https://github.com/tensorflow/tflite-micro-arduino-examples">tflite-micro-arduino-examples</a> and <a href="https://github.com/ArduCAM/RPI-Pico-Cam">RPI-Pico-Cam</a> with the current devices.</p>
<p>You might need to add device-specific code for taking pictures with the camera and printing values to serial. Device-specific repositories often already include this code.</p>
</section>
<section id="modify-the-example-to-work-with-models-created-by-tinymlaas" class="level3">
<h3 class="anchored" data-anchor-id="modify-the-example-to-work-with-models-created-by-tinymlaas">3. Modify the example to work with models created by TinyMLaaS</h3>
<p>You need to make the following changes to the example code:</p>
<ul>
<li><p><strong>(main_functions.cpp)</strong> <code>kTensorArenaSize</code> should be set to at least 182 kilobytes (this is the amount of memory that must be given to tflite-micro for our model to work).</p></li>
<li><p><strong>(main_functions.cpp)</strong> The micro_op_resolver variable should be modified to contain all 11 operations needed by our model. You can copy its definition from arduino/template/template.ino (These will have to be changed if the model training code is modified).</p></li>
<li><p><strong>(person_detect_model_data.h)</strong> The extern declarations should match what is generated by nbs/compiling.ipynb. You can copy the contents of arduino/template/person_detect_model_data.h.</p></li>
<li><p><strong>(main_functions.cpp)</strong> The model passed to <code>tflite::GetModel</code> should be the array from the previous step. <code>model_tflite</code> is the currently used name for it.</p></li>
<li><p><strong>(person_detect_model_data.cpp)</strong> replace this file with a <strong>model.cc</strong> created by the webapp. You can obtain one by copying it out of the frontend docker container after running training and compiling in the webapp. You could also just copy rpi-pico/code/person_detection_screen/person_detection_data.cpp which was created this way.</p></li>
<li><p><strong>(detection_responder.h / detection_responder.cpp / main_functions.cpp)</strong> Modify the <code>RespondToDetection</code> function (and the code calling it) to print detections in the format expected by nbs/observing.ipynb. You can copy the code from one of the existing devices.</p></li>
<li><p>Our model currently operates on grayscale images, make sure that that’s what the camera code is producing. We’ve also only used 96x96 images so you might need to change something else if the camera resolution is different.</p></li>
</ul>
<p>In theory you should now have the person_detection app running with a custom model, but in our experience this is the part where the app mysteriously stops working. Here are the issues that we encountered:</p>
<ul>
<li><p><strong>kTensorArenaSize is too small</strong>: this causes an error message to get printed via serial on setup(), and causes the inference code to repeatedly print <code>Invoke failed</code> errors to serial.</p></li>
<li><p><strong>micro_op_resolver doesn’t have the necessary ops</strong>: this causes an error message to get printed via serial on setup(), and causes the inference code to repeatedly print <code>Invoke failed</code> errors to serial. This should not happen if you followed the steps above.</p></li>
<li><p><strong>Unaligned model data</strong>: The app was crashing inside tensorflow’s AllocateTensors function with no errors. The fix was to add <code>alignas(16)</code> specifier to the model data array. This is currently not done on either device, so this might only be needed with older tflite-micro versions.</p></li>
<li><p><strong>Outdated tflite-micro</strong>: The app was crashing inside tensorflow’s AllocateTensors function with no errors. We were initially using a library called “Harward TinyMLx” with Arduino. This contained both tflite-micro and camera code for the device, however the tflite version was outdated. Switching to a newer tflite-micro version fixed the issue. A quick way to tell the version the example is using is to look at how printing is done. If you see mentions of <code>tflite::ErrorReporter</code>/<code>TF_LITE_REPORT_ERROR</code>, the code is using the old version. Newer versions use <code>MicroPrintf</code> instead.</p></li>
<li><p><strong>Running out of memory</strong>: The Pico4ML was crashing inside the GetImage function with no error messages. This happened because the camera code was internally creating a 324x324 array on the stack, which combined with our increased kTensorArenaSize was causing the device to not have enough memory (presumably the stack was overflowing). Reducing the size of the array in the camera code fixed this issue.</p></li>
</ul>
</section>
<section id="create-a-dockerfile-for-building-the-code" class="level3">
<h3 class="anchored" data-anchor-id="create-a-dockerfile-for-building-the-code">4. Create a dockerfile for building the code</h3>
<p>The dockerfile should produce an image that contains the compiled person_detection application, which can then be installed by the relay with only docker.</p>
</section>
<section id="modify-the-webapp-to-build-the-code" class="level3">
<h3 class="anchored" data-anchor-id="modify-the-webapp-to-build-the-code">5. Modify the Webapp to build the code</h3>
<ul>
<li><p>Create a subclass of InstallerImageBuilder in nbs/installing.ipynb to pass the model file to the dockerfile, build the docker image, and upload it to dockerhub.</p></li>
<li><p>Edit the devices dictionary in pages/6_Installing.py to include your new device, its InstallerImageBuilder class, and a relay_id that will be used to refer to the device on the relay server side.</p></li>
<li><p>Edit the install_inference function in relay/components/install.py to install the model on to the device using the docker image downloaded from dockerhub.</p></li>
</ul>
</section>
</section>
<section id="debugging-tip" class="level1">
<h1>Debugging Tip</h1>
<p>Printing messages to serial is very useful for debugging. You can use them to determine values of variables or where the program is crashing. Also the tflite-micro library internally uses its MicroPrintf function to print error messages to serial, so reading from serial is also useful for finding out the cause of problems with tflite.</p>
<p>You can read data from serial with a tool called minicom: <code>minicom -b 115200 -D /dev/ttyACM0</code></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>